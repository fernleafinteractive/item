!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.src=a.src||{})}(this,function(a){"use strict";$.widget("fernleaf.item",{options:{station:"",sdate:"por",edate:"2016-12-31",variable:"precipitation",threshold:1,thresholdOperator:">",thresholdFilter:"",thresholdFunction:void 0,window:1,dailyValueValidator:void 0,yearValidator:void 0,barColor:"#307bda",dataAPIEndpoint:"https://data.rcc-acis.org/"},_variables:{precipitation:{queryElements:[{name:"pcpn",units:"inch"}],windowBehavior:"rollingSum"},tmax:{queryElements:[{name:"maxt",units:"degreeF"}],windowBehavior:"all"},tmin:{queryElements:[{name:"mint",units:"degreeF"}],windowBehavior:"all"},tavg:{queryElements:[{name:"avgt",units:"degreeF"}],windowBehavior:"all"}},_dailyValues:null,_operators:{"==":function(a,b){return a==b},">=":function(a,b){return a>=b},">":function(a,b){return a>b},"<=":function(a,b){return a<=b},"<":function(a,b){return a<b}},_views:{},_filters:{KtoC:function(a){return a+273.15},CtoK:function(a){return a-273.15},FtoC:function(a){return 9*a/5+32},CtoF:function(a){return 5*(a-32)/9},InchToCM:function(a){return 2.54*a},CMtoInch:function(a){return a/2.54},DaytoWeek:function(a){return a/7},WeektoDay:function(a){return 7*a},DaytoYear:function(a){return a/365},YeartoDay:function(a){return 365*a}},_create:function(){$(this.element).addClass("fl-item"),this.update()},update:function(){var a=this;_.forEach(this._views,function(a){a.remove()}),this._views={};var b=void 0;null===this._dailyValues&&(b=Promise.resolve(this._getDailyValuesByStation()).then(function(b){a._dailyValues=b})),Promise.resolve(b).then(function(){a._showExceedanceTimelineGraph(a._dailyValues)})},_setOption:function(a,b){"threshold"===a&&this.options.thresholdFilter in this._filters&&(b=this._filters[this.options.thresholdFilter](b)),"sdate"===a&&(b=b?String(b).slice(0,4)+"-01-01":"por"),"edate"===a&&(b=void 0===b||parseInt(String(b).slice(0,4))>=parseInt((new Date).getFullYear())?String(parseInt((new Date).getFullYear())-1)+"-12-31":String(b).slice(0,4)+"-12-31"),this._super(a,b),["station","variable","sdate","edate"].includes(a)&&this._clearData()},getDailyValues:function(){return this._dailyValues},_getDailyValuesByStation:function(){var a=this;return this._updateSpinner("loading data..."),Promise.resolve($.ajax({url:this.options.dataAPIEndpoint+"StnData",type:"POST",context:this,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify({sid:this.options.station,sdate:this.options.sdate,edate:this.options.edate,elems:this._variables[this.options.variable].queryElements})})).then(function(b){var c="function"==typeof a.options.dailyValueValidator?a.options.dailyValueValidator:function(a,b,c){return Number.isFinite(a)};return _.mapValues(_.fromPairs(b.data),function(a,b,d){return a=Number.parseFloat(a),{value:a,valid:c(a,b,d)}})})},getYearExceedance:function(a){var b=this,c="function"==typeof this.options.yearValidator?this.options.yearValidator:function(){return!0};return _.chain(a).reduce(function(a,b,c){var d=String(c).slice(0,4);return a[d]=a[d]||{},a[d][c]=b,a},{}).mapValues(function(d,e,f){var g=_.reduce(d,function(c,d,e){var f=[];d.valid&&f.push(d.value);for(var g=b.options.window-1;g>0;g--){var h=new Date(e);h.setDate(h.getDate()-g),h=h.toISOString().slice(0,10),void 0!==a[h]&&a[h].valid&&f.push(a[h].value)}return f.length>0&&b._thresholdFunction(f)?c+1:c},0);return{exceedance:g,valid:c(g,d,e,f,a),dailyValues:d}}).value()},_thresholdFunction:function(a){var b=this;if("function"===this.options.thresholdFunction)return this.options.thresholdFunction(this,a);var c=this._operators[this.options.thresholdOperator];switch(this._variables[this.options.variable].windowBehavior){case"rollingSum":return c(_.sum(a),this.options.threshold);case"any":return _.any(a,function(a){return c(a,b.options.threshold)});case"all":return _.every(a,function(a){return c(a,b.options.threshold)})}},_updateSpinner:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",b=$(this.element).children("div.spinner");b.length?""===a||!1===a?b.remove():b.children(".msg").text(a):!1!==a&&$(this.element).append('<div class="spinner"><i class="spinner-icon"></i><span class="sr-only">Loading...</span><span class="msg">'+a+"</span></div>")},_showExceedanceTimelineGraph:function(a){if(this._updateSpinner(!1),_.forEach(this._views,function(a){a.hide()}),void 0!==this._views.$yearlyExceedanceGraph)return void this._views.$yearlyExceedanceGraph.show();var b=this.getYearExceedance(a),c=_(b).toPairs().map(function(a){return{x:String(a[0]),y:a[1].valid?a[1].exceedance:Number.NaN}}).sortBy("x").value();this._views.$yearlyExceedanceGraph=$("<canvas></canvas>").uniqueId().appendTo(this.element),this.chart=new Chart(this._views.$yearlyExceedanceGraph,{label:"Yearly Exceedance",type:"bar",animationEnabled:!1,data:{datasets:[{label:"Yearly Exceedance",data:c||[],fill:!0,backgroundColor:this.options.barColor?this.options.barColor:"#307bda"}]},options:{animation:{duration:0},scales:{xAxes:[{type:"time",display:!0,distribution:"linear",time:{unit:"year",unitStepSize:3,max:String(parseInt(String(this.options.edate).slice(0,4))+1)},scaleLabel:{display:!0,labelString:"Year"},position:"bottom"}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:"Events per Year Above Threshold"},ticks:{beginAtZero:!0}}]},tooltips:{callbacks:{afterLabel:function(a,c){return 0===a.datasetIndex?"Invalid/missing daily values: "+_.size(_.filter(b[c.datasets[0].data[a.index].x].dailyValues,function(a){return!1===a.valid})):""}}}}})},getPercentileValue:function(a){var b=_(this._dailyValues).filter(function(a){return a.valid&&a.value>0}).sortBy(function(a){return a.value}).value(),c=b.length,d=void 0;return(a/=100)<=0?b[0].value:a>=1?b[c-1].value:(d=c*a-1)===Math.floor(d)?_.round((b[d].value+b[d+1].value)/2,3):(d=Math.ceil(d),_.round(b[d].value,3))},_clearData:function(){this._dailyValues=null}}),Object.defineProperty(a,"__esModule",{value:!0})});
